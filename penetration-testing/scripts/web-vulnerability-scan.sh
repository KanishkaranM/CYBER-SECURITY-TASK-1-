#!/bin/bash
# Web Application Vulnerability Scanning Script
# Usage: ./web-vulnerability-scan.sh <TARGET_URL>

set -e

if [ -z "$1" ]; then
    echo "Usage: $0 <TARGET_URL>"
    echo "Example: $0 http://example.com"
    exit 1
fi

TARGET_URL=$1
OUTPUT_DIR="./web-scan-results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Create output directory
mkdir -p "$OUTPUT_DIR"

echo "============================================"
echo "Starting Web Vulnerability Scan"
echo "Target: $TARGET_URL"
echo "Timestamp: $TIMESTAMP"
echo "============================================"

# 1. Nikto Scan
echo "[*] Running Nikto web server scanner..."
nikto -h "$TARGET_URL" -output "$OUTPUT_DIR/${TIMESTAMP}_nikto_scan.txt" || echo "Nikto scan completed with warnings"

# 2. WhatWeb - Web Technology Detection
echo "[*] Running WhatWeb for technology fingerprinting..."
whatweb -v "$TARGET_URL" > "$OUTPUT_DIR/${TIMESTAMP}_whatweb.txt" || echo "WhatWeb completed"

# 3. HTTP Header Analysis
echo "[*] Analyzing HTTP headers..."
curl -I -L "$TARGET_URL" > "$OUTPUT_DIR/${TIMESTAMP}_http_headers.txt" 2>&1

# 4. Security Headers Check
echo "[*] Checking security headers..."
cat > "$OUTPUT_DIR/${TIMESTAMP}_security_headers_analysis.txt" << EOF
Security Headers Analysis for: $TARGET_URL
==========================================

EOF

# Function to check header
check_header() {
    local header=$1
    local url=$2
    if curl -s -I "$url" | grep -i "$header" > /dev/null; then
        echo "✓ $header: PRESENT" >> "$OUTPUT_DIR/${TIMESTAMP}_security_headers_analysis.txt"
        curl -s -I "$url" | grep -i "$header" >> "$OUTPUT_DIR/${TIMESTAMP}_security_headers_analysis.txt"
    else
        echo "✗ $header: MISSING" >> "$OUTPUT_DIR/${TIMESTAMP}_security_headers_analysis.txt"
    fi
}

# Check important security headers
check_header "Strict-Transport-Security" "$TARGET_URL"
check_header "Content-Security-Policy" "$TARGET_URL"
check_header "X-Frame-Options" "$TARGET_URL"
check_header "X-Content-Type-Options" "$TARGET_URL"
check_header "X-XSS-Protection" "$TARGET_URL"
check_header "Referrer-Policy" "$TARGET_URL"
check_header "Permissions-Policy" "$TARGET_URL"

# 5. Directory Enumeration (if dirb/dirbuster available)
if command -v dirb &> /dev/null; then
    echo "[*] Running directory enumeration with dirb..."
    dirb "$TARGET_URL" /usr/share/wordlists/dirb/common.txt -o "$OUTPUT_DIR/${TIMESTAMP}_dirb_scan.txt" -S -w || echo "Dirb completed"
fi

# 6. SSL/TLS Testing (if HTTPS)
if [[ $TARGET_URL == https://* ]]; then
    echo "[*] Testing SSL/TLS configuration..."
    
    # Extract hostname
    HOSTNAME=$(echo "$TARGET_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
    
    # SSLyze scan (if available)
    if command -v sslyze &> /dev/null; then
        sslyze --regular "$HOSTNAME" > "$OUTPUT_DIR/${TIMESTAMP}_sslyze.txt" || echo "SSLyze completed"
    fi
    
    # OpenSSL test
    echo | openssl s_client -connect "$HOSTNAME:443" -servername "$HOSTNAME" 2>&1 | tee "$OUTPUT_DIR/${TIMESTAMP}_openssl_test.txt"
fi

# 7. Robots.txt Analysis
echo "[*] Checking robots.txt..."
curl -s "${TARGET_URL}/robots.txt" > "$OUTPUT_DIR/${TIMESTAMP}_robots.txt" 2>&1

# 8. Common Files Check
echo "[*] Checking for common sensitive files..."
cat > "$OUTPUT_DIR/${TIMESTAMP}_sensitive_files_check.txt" << EOF
Sensitive Files Check
=====================
EOF

check_file() {
    local file=$1
    echo -n "Checking $file... " >> "$OUTPUT_DIR/${TIMESTAMP}_sensitive_files_check.txt"
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${TARGET_URL}${file}")
    if [ "$STATUS" -eq 200 ]; then
        echo "FOUND (Status: $STATUS)" >> "$OUTPUT_DIR/${TIMESTAMP}_sensitive_files_check.txt"
    else
        echo "Not Found (Status: $STATUS)" >> "$OUTPUT_DIR/${TIMESTAMP}_sensitive_files_check.txt"
    fi
}

check_file "/.git/config"
check_file "/.env"
check_file "/config.php"
check_file "/phpinfo.php"
check_file "/admin"
check_file "/backup.sql"
check_file "/.htaccess"
check_file "/web.config"

# 9. Generate Summary Report
echo "[*] Generating summary report..."
cat > "$OUTPUT_DIR/${TIMESTAMP}_scan_summary.txt" << EOF
Web Vulnerability Scan Summary
==============================
Target: $TARGET_URL
Scan Date: $(date)
Scan ID: $TIMESTAMP

Files Generated:
---------------
1. ${TIMESTAMP}_nikto_scan.txt - Nikto web server scan
2. ${TIMESTAMP}_whatweb.txt - Technology fingerprinting
3. ${TIMESTAMP}_http_headers.txt - Raw HTTP headers
4. ${TIMESTAMP}_security_headers_analysis.txt - Security headers analysis
5. ${TIMESTAMP}_dirb_scan.txt - Directory enumeration (if available)
6. ${TIMESTAMP}_robots.txt - Robots.txt content
7. ${TIMESTAMP}_sensitive_files_check.txt - Common files check
EOF

if [[ $TARGET_URL == https://* ]]; then
    cat >> "$OUTPUT_DIR/${TIMESTAMP}_scan_summary.txt" << EOF
8. ${TIMESTAMP}_sslyze.txt - SSL/TLS security scan (if available)
9. ${TIMESTAMP}_openssl_test.txt - OpenSSL connection test
EOF
fi

cat >> "$OUTPUT_DIR/${TIMESTAMP}_scan_summary.txt" << EOF

Key Findings:
------------
Review the individual scan files for detailed findings.

Recommendations:
---------------
1. Review security headers analysis for missing protections
2. Check Nikto results for known vulnerabilities
3. Verify SSL/TLS configuration (if HTTPS)
4. Ensure no sensitive files are publicly accessible

EOF

echo "============================================"
echo "Web vulnerability scan completed!"
echo "Results saved to: $OUTPUT_DIR"
echo "Summary: $OUTPUT_DIR/${TIMESTAMP}_scan_summary.txt"
echo "============================================"
